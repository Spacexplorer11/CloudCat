<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>CloudCat</title>
    <style>
        html,
        body,
        canvas {
            margin: 0px;
            padding: 0px;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: absolute;
            background: black;
            z-index: 0;
        }
    </style>
</head>

<body>
    <canvas id="glcanvas" tabindex='1'></canvas>
    <!-- Miniquad stuff -->
    <script>
        function load(file) {
            return fetch(file)
                .then(response => response.arrayBuffer());
        };

        let wasm_exports = {};

        let importObject = {
            env: {
                console_log: function(ptr, len) {
                    let array = new Uint8Array(wasm_exports.memory.buffer, ptr, len);
                    let string = new TextDecoder().decode(array);
                    console.log(string);
                },
                console_error: function(ptr, len) {
                    let array = new Uint8Array(wasm_exports.memory.buffer, ptr, len);
                    let string = new TextDecoder().decode(array);
                    console.error(string);
                },
                set_cursor_grab: function() {},
                show_mouse: function() {},
                canvas_width: function() {
                    return Math.floor(window.innerWidth);
                },
                canvas_height: function() {
                    return Math.floor(window.innerHeight);
                },
                dpi_scale: function() {
                    return window.devicePixelRatio || 1.0;
                },
                high_dpi: function() {
                    return window.devicePixelRatio > 1.0 ? 1 : 0;
                },
            }
        };

        load('./cloudcat.wasm').then(bytes =>
            WebAssembly.instantiate(bytes, importObject)).then(results => {
            let mod = results.instance;
            wasm_exports = mod.exports;

            let canvas = document.getElementById('glcanvas');
            
            function resize() {
                canvas.width = Math.floor(window.innerWidth);
                canvas.height = Math.floor(window.innerHeight);
            }
            resize();
            window.addEventListener('resize', resize);

            // Get WebGL context
            let gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (!gl) {
                console.error("WebGL is not supported");
                return;
            }
            
            // Setup canvas for mouse/touch input
            canvas.addEventListener('click', function(event) {
                canvas.focus();
            });
            
            canvas.focus();

            mod.exports.main();
        });
    </script>
</body>

</html>